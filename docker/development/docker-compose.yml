volumes:
  cript_pg_data:

networks:
  # cripta_net doesn't expose it's connected containers to outside world (even localhost).
  # Postgres
  cripta_net:

  # connect_with_host has only one container that's bridged to localhost.
  # cripta, Hashicorp Vault
  connect_with_host:
    driver: bridge
    driver_opts:
      com.docker.network.bridge.host_binding_ipv4: "127.0.0.1"


services:
  pg:
    image: postgres:latest
    networks:
      - cripta_net
    volumes:
      - cript_pg_data:/var/lib/postgresql/data
    environment:
      POSTGRES_USER: db_user
      POSTGRES_PASSWORD: db_pass
      POSTGRES_DB: encryption_db
    healthcheck:
      test: ["CMD-SHELL", "pg_isready"]
      interval: 5s
      retries: 3
      start_period: 5s
      timeout: 5s

  hashicorpvault:
    profiles:
      - vault
    image: hashicorp/vault:latest
    networks:
      - cripta_net
      # Remove below network to disable access from local system
      - connect_with_host
    ports:
      - "8200:8200"
    environment:
      VAULT_DEV_ROOT_TOKEN_ID: vault_token
  
  hashicorpvault-initialize:
    profiles:
      - vault
    image: hashicorp/vault:latest
    # Give 5secs of time after staring of hashicorpvault service and before connecting to initialize the vault with encryption key.
    command: |
      /bin/sh -c "sleep 5 && vault secrets enable transit && vault write -f transit/keys/orders"
    networks:
      - cripta_net
    environment:
      VAULT_ADDR: "http://hashicorpvault:8200"
      VAULT_TOKEN: vault_token
    depends_on:
      hashicorpvault:
        condition: service_started
  
  cripta-migration:
    build:
     dockerfile_inline: |
        FROM rust:latest
        RUN apt-get update
        RUN cargo install diesel_cli --no-default-features --features postgres
    command: |
      /bin/sh -c "diesel migration run"
    working_dir: /cripta
    networks:
      - cripta_net
    volumes:
      - ../..:/cripta
    environment:
      DATABASE_URL: "postgres://db_user:db_pass@pg:5432/encryption_db"
    depends_on:
      pg:
        condition: service_healthy
  
  cripta: &cripta-block
    profiles:
      - aes
    build:
      context: ../..
      dockerfile_inline: |
        FROM rust:latest
        RUN apt-get update
        WORKDIR /cripta
        COPY Cargo.toml /cripta/Cargo.toml
        RUN cargo fetch
        RUN cargo install cargo-watch
    command: |
      /bin/sh -c "cargo watch -x run"
    environment: &cripta-env
      CRIPTA__database__host: pg
      CRIPTA__metrics_server__host: "0.0.0.0"
      CRIPTA__server__host: "0.0.0.0"
    volumes:
      - ../..:/cripta
    working_dir: /cripta
    networks:
      - cripta_net
      - connect_with_host
    ports:
      - "5000:5000"
      - "6128:6128"
    depends_on: &cripta-depends_on
      pg:
        condition: service_healthy
      cripta-migration:
        condition: service_completed_successfully

  cripta-vault:
    profiles:
      - vault
    <<: *cripta-block
    command: |
       /bin/sh -c "cargo run --no-default-features --features vault"
    environment:
      <<: *cripta-env
      CRIPTA__secrets__vault_token: vault_token
      CRIPTA__secrets__vault_config__url: "http://hashicorpvault:8200"
    depends_on:
      <<: *cripta-depends_on
      hashicorpvault:
        condition: service_started
      hashicorpvault-initialize:
        condition: service_completed_successfully
      

    
    
    
      

